name: DnsTools 云编译

on:
  push:
    branches: [ main ]  # 推送到main分支时触发编译
  workflow_dispatch:   # 支持手动触发编译

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest, macos-latest, ubuntu-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: 20  # 匹配项目依赖的Node版本
          cache: 'npm'

      - name: 安装依赖（通用）
        run: npm install

      - name: 安装 Tauri 依赖（按系统区分）
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            npm install -g @tauri-apps/cli
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install rustup
            rustup-init -y
            source $HOME/.cargo/env
            npm install -g @tauri-apps/cli
          elif [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt update
            sudo apt install -y libwebkit2gtk-4.0-dev build-essential curl wget libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source $HOME/.cargo/env
            npm install -g @tauri-apps/cli
          fi
        shell: bash

      - name: 编译项目
        run: npm run tauri build

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: DnsTools-${{ matrix.platform }}
          path: |
            src-tauri/target/release/bundle/**/*
            src-tauri/target/release/DnsTools*
